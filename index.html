<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Ø­Ø§Ø³Ø¨Ø© Ø§Ù„Ø§Ø¹Ù„Ø§Ù†Ø§Øª (CPA, ROI, CAC, LTV)</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" onerror="window._jspdfLoadError=true"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" onerror="window._html2canvasLoadError=true"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js" onerror="window._chartLoadError=true"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css">
<style>
:root{
  --bg:#f6f8fb; --card:#ffffff; --text:#0f1724; --muted:#6b7280; --accent:#4f46e5;
  --good:#10b981; --bad:#ef4444; --warn:#f97316; --purple:#8b5cf6; --orange:#f59e0b;
}
.dark-mode{
  --bg:#121212; --card:#1e1e1e; --text:#f5f5f5; --muted:#aaa; --accent:#8b5cf6;
  --good:#22c55e; --bad:#f87171; --warn:#fb923c; --purple:#a78bfa; --orange:#fbbf24;
}
body{background:var(--bg);color:var(--text);font-family:'Cairo',sans-serif;padding:24px;transition:all 0.3s;}
.card-app{background:var(--card);border-radius:14px;padding:20px;box-shadow:0 8px 30px rgba(2,6,23,0.06);transition:all 0.3s;}
h1{font-size:20px;margin:0 0 6px;color:var(--accent);}
.muted{color:var(--muted);font-size:0.95rem;}
label{font-weight:700;color:var(--text);}
input.form-control, select.form-select{border-radius:10px;border:1px solid #e6eef8;background:var(--card);color:var(--text);}
.controls{gap:12px}
.summary-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:14px;margin-top:18px}
.summary-card{background:linear-gradient(180deg,var(--card),#f3f4f6);padding:14px;border-radius:12px;box-shadow:0 6px 18px rgba(2,6,23,0.04);border-left:6px solid var(--accent);transition:all 0.3s;}
.summary-card .title{font-weight:800;color:var(--text);margin-bottom:6px}
.summary-card .value{font-size:1.25rem;font-weight:900}
.value.good{color:var(--good)}
.value.bad{color:var(--bad)}
.value.warn{color:var(--warn)}
.table-card{margin-top:18px;padding:12px;background:var(--card);border-radius:12px;box-shadow:0 6-px 18px rgba(2,6,23,0.04);transition:all 0.3s;}
table{font-size:0.95rem;border-collapse:collapse;width:100%;transition:all 0.3s;}
thead th{background:linear-gradient(90deg,#16a34a,#4ade80);color:#fff;position:sticky;top:0;z-index:1;padding:8px;border:1px solid #ccc;}
tbody td{border:1px solid #ccc;padding:6px;text-align:center;color:var(--text);}
tbody tr:hover{background:rgba(79,70,229,0.1);cursor:pointer;}
.small-muted{font-size:0.88rem;color:var(--muted);}
#status{min-height:20px}
/* Standard Mode */
.standard-mode #monthlyCosts-group, .standard-mode #confirmationRate-group, .standard-mode #itemPrice-group, .standard-mode #shippingCost-group, .standard-mode #sellingPriceAffiliate-group, .standard-mode #commission-group { display: none; }
.standard-mode .affiliate-column { display: none; }
.standard-mode .ecommerce-column { display: table-cell; }
.standard-mode #ltv-table-detailed, .standard-mode #charts-detailed { display: block; }
/* Advanced Mode */
.advanced-mode #itemPrice-group, .advanced-mode #shippingCost-group, .advanced-mode #sellingPriceAffiliate-group, .advanced-mode #commission-group { display: none; }
.advanced-mode #targetOrders-group label { content: "Ù…Ø¹Ø§Ùƒ ÙƒØ§Ù… Ø§ÙˆØ±Ø¯Ø±"; }
.advanced-mode .affiliate-column { display: none; }
.advanced-mode .ecommerce-column { display: table-cell; }
.advanced-mode #ltv-table-detailed, .advanced-mode #charts-detailed { display: block; }
/* Affiliate Mode */
.affiliate-mode #price-group, .affiliate-mode #cogs-group, .affiliate-mode #shippingDelivered-group, .affiliate-mode #shippingReturn-group, .affiliate-mode #ltvMultiplier-group { display: none; }
.affiliate-mode #itemPrice-group, .affiliate-mode #shippingCost-group, .affiliate-mode #sellingPriceAffiliate-group, .affiliate-mode #confirmationRate-group, .affiliate-mode #monthlyCosts-group, .affiliate-mode #commission-group { display: block; }
.affiliate-mode #targetOrders-group label { content: "Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙˆØ±Ø¯Ø±Ø§Øª"; }
.affiliate-mode .ecommerce-column { display: none; }
.affiliate-mode .affiliate-column { display: table-cell; }
.affiliate-mode #ltv-table-detailed, .affiliate-mode #charts-detailed { display: none; }
/* New CSS for read-only fields */
input.form-control[readonly] {
    background-color: var(--bg);
    opacity: 0.7;
    cursor: not-allowed;
    border-color: #d1d5db;
}
.dark-mode input.form-control[readonly] {
    background-color: #2a2a2a;
    border-color: #3b3b3b;
}
@media (max-width:768px){ .controls .col-md-3, .controls .col-md-4, .controls .col-md-9{flex:0 0 100%;max-width:100%} }

/* Popup Styling */
.popup-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.7);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1000;
    visibility: hidden;
    opacity: 0;
    transition: visibility 0s, opacity 0.5s linear;
}

.popup-content {
    background: var(--card);
    padding: 30px;
    border-radius: 14px;
    box-shadow: 0 8px 30px rgba(2, 6, 23, 0.15);
    text-align: center;
    position: relative;
    max-width: 400px;
    width: 90%;
}

.popup-content h2 {
    color: var(--accent);
    margin-top: 0;
}

.popup-content p {
    color: var(--text);
    margin-bottom: 20px;
}

.popup-content h3 {
    color: var(--text);
    margin-top: 25px;
    margin-bottom: 15px;
    font-size: 1.1rem;
    font-weight: 600;
}

.popup-content .palestine-support-message {
    font-size: 1.05rem;
    font-weight: 600;
    color: var(--text);
    margin-bottom: 15px;
}

.popup-content .palestine-flag-emoji {
    font-size: 2em; /* Make the flag emoji larger */
    display: block; /* Ensure it's on its own line */
    margin: 0 auto 20px; /* Center it and add space below */
}


.close-btn {
    background: var(--accent);
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 8px;
    cursor: pointer;
    font-weight: bold;
    margin-top: 20px;
}
/* Social Icons Styling */
.social-icons {
  margin-top: 20px;
  margin-bottom: 20px;
}
.social-icons a {
  font-size: 30px;
  margin: 0 10px;
  color: var(--accent);
  transition: transform 0.2s;
}
.social-icons a:hover {
  transform: scale(1.1);
  color: #0d6efd;
}
</style>
</head>
<body class="standard-mode">
<div class="app">
  <div class="card-app">
    <div class="d-flex justify-content-between align-items-start mb-3">
      <div>
        <h1>ğŸ“ŠğŸ‡µğŸ‡¸ E-Commerce Calculator</h1>
        <div class="muted">Ø£Ø­Ø³Ø¨ Ø¨ÙƒÙ„ Ø³Ù‡ÙˆÙ„Ø© Ø¨Ø£Ø®ØªÙŠØ§Ø±Ø§Øª ØªØ­Ù…ÙŠÙ„ Ù…Ø±Ù†Ø© (ØªØµÙ…ÙŠÙ… : Ù…Ø­Ù…ÙˆØ¯ Ø²ÙƒÙŠ)</div>
      </div>
      <div class="d-flex gap-2 align-items-center">
        <select id="currency" class="form-select" style="width:110px">
          <option value="EGP">EGP</option>
          <option value="USD">USD</option>
          <option value="EUR">EUR</option>
          <option value="SAR">SAR</option>
        </select>
        <button id="standardModeBtn" class="btn btn-primary">Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø¹Ø§Ø¯ÙŠØ©</button>
        <button id="advancedModeBtn" class="btn btn-outline-secondary">Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©</button>
        <button id="affiliateModeBtn" class="btn btn-outline-secondary">Ù†Ø³Ø®Ø© Ø§Ù„Ø£ÙÙ„ÙŠÙŠØª</button>
        <button id="exportCsv" class="btn btn-outline-secondary">â¬‡ï¸ CSV</button>
        <button id="exportPdf" class="btn btn-outline-secondary">â¬‡ï¸ PDF</button>
      </div>
    </div>
    <div id="status" class="small-muted mb-2"></div>
    <div class="row controls g-3">
      <div class="col-md-3" id="price-group">
        <label>ğŸ’µ Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹ (AOV)</label>
        <input id="price" class="form-control" type="number" value="">
      </div>
      <div class="col-md-3" id="cogs-group">
        <label>ğŸ“¦ ØªÙƒÙ„ÙØ© Ø§Ù„Ù…Ù†ØªØ¬ (COGS)</label>
        <input id="cogs" class="form-control" type="number" value="">
      </div>
      <div class="col-md-3" id="shippingDelivered-group">
        <label>ğŸšš Ø´Ø­Ù† Ø§Ù„Ø§ÙˆØ±Ø¯Ø± Ø§Ù„Ù…ØªØ³Ù„Ù…</label>
        <input id="shippingDelivered" class="form-control" type="number" value="">
      </div>
      <div class="col-md-3" id="shippingReturn-group">
        <label>ğŸšš Ø´Ø­Ù† Ø§Ù„Ø§ÙˆØ±Ø¯Ø± Ø§Ù„Ù…Ø±ØªØ¬Ø¹</label>
        <input id="shippingReturn" class="form-control" type="number" value="">
      </div>
      <div class="col-md-3" id="itemPrice-group">
        <label>ğŸ“¦ ØªÙƒÙ„ÙØ© Ø§Ù„Ù…Ù†ØªØ¬</label>
        <input id="itemPrice" class="form-control" type="number" value="">
      </div>
      <div class="col-md-3" id="shippingCost-group">
        <label>ğŸšš ØªÙƒÙ„ÙØ© Ø´Ø­Ù† Ø§Ù„Ø£ÙˆØ±Ø¯Ø±</label>
        <input id="shippingCost" class="form-control" type="number" value="">
      </div>
      <div class="col-md-3" id="sellingPriceAffiliate-group">
        <label>ğŸ’° Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹ Ø´Ø§Ù…Ù„ Ø§Ù„Ø´Ø­Ù†</label>
        <input id="sellingPriceAffiliate" class="form-control" type="number" value="">
      </div>
      <div class="col-md-3" id="commission-group">
        <label>ğŸ Ø¹Ù…ÙˆÙ„Ø© Ø§Ù„Ø£ÙˆØ±Ø¯Ø±</label>
        <input id="orderCommission" class="form-control" type="number" value="" readonly>
      </div>
      <div class="col-md-3" id="targetOrders-group">
        <label id="targetOrdersLabel">ğŸ¯ Ø¹Ø§ÙŠØ² ÙƒØ§Ù… Ø§ÙˆØ±Ø¯Ø±</label>
        <input id="targetOrders" class="form-control" type="number" value="">
      </div>
      <div class="col-md-3" id="confirmationRate-group">
        <label>âœ… Ù†Ø³Ø¨Ø© ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø·Ù„Ø¨Ø§Øª (%)</label>
        <input id="confirmationRate" class="form-control" type="number" value="">
      </div>
      <div class="col-md-3">
        <label>ğŸ“ˆ Ù†Ø³Ø¨Ø© Ø§Ù„ØªØ³Ù„ÙŠÙ… (%)</label>
        <input id="deliveryRate" class="form-control" type="number" value="">
      </div>
      <div class="col-md-3" id="ltvMultiplier-group">
        <label>ğŸ” LTV â€” Ù…ØªÙˆÙ‚Ø¹ Ø§Ù„Ø¹Ù…ÙŠÙ„ ÙŠØ´ØªØ±ÙŠ ÙƒØ§Ù… Ù…Ø±Ø© </label>
        <input id="ltvMultiplier" class="form-control" type="number" step="0.1" value="">
      </div>
      <div class="col-md-3" id="monthlyCosts-group">
        <label>ğŸ’¸ Ø§Ù„ØªÙƒØ§Ù„ÙŠÙ Ø§Ù„Ø´Ù‡Ø±ÙŠØ© Ø§Ù„Ø«Ø§Ø¨ØªØ©</label>
        <input id="monthlyCosts" class="form-control" type="number" value="">
      </div>
      <div class="col-md-9" id="cpaInput-group">
        <label>ğŸ“Œ Ø­Ø· Ø§Ù„Ù€ CPA (Ø­Ø· Ø¹Ù„Ø§Ù… , Ø¨ÙŠÙ† ÙƒÙ„ Ø±Ù‚Ù… ÙˆØ§Ù„ØªØ§Ù†ÙŠ)</label>
        <input id="cpaInput" class="form-control" type="text" value="10,20,30,40,50,75,100,200,300,400,500">
        <div class="small-muted mt-1">Ù…Ø«Ø§Ù„: 10,20,30 Ø£Ùˆ 5-200:5</div>
      </div>
    </div>
    <div class="d-flex align-items-end gap-2 mt-3">
      <button id="calcBtn" class="btn btn-primary w-100">âš¡ Ø§Ø­Ø³Ø¨ Ø¯Ù„ÙˆÙ‚ØªÙŠ</button>
      <button id="clearBtn" class="btn btn-outline-danger w-100">ğŸ§¹ Ø§Ù…Ø³Ø­ Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª</button>
    </div>
    <div class="summary-grid" id="summaryGrid-detailed"></div>
    <div class="table-card mt-3" id="detailed-results">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <div><strong>ğŸ“‹ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù†ØªØ§Ø¦Ø¬</strong><div class="small-muted">Ù‡Ù†Ø­Ø³Ø¨Ù„Ùƒ ÙƒÙ„ Ø§Ù„ØªÙƒÙ„ÙØ© Ø­Ø³Ø¨ ÙƒÙ„ CPA ÙˆÙ†Ø³Ø¨Ø© Ø§Ù„ØªØ³Ù„ÙŠÙ…Ø§Øª ÙƒÙ…Ø§Ù†.</div></div>
      </div>
      <div class="table-responsive">
        <table class="table table-bordered table-sm" id="resultsTable">
          <thead>
            <tr>
              <th>CPA</th>
              <th>Ø§Ù„Ø§ÙˆØ±Ø¯Ø± Ø§Ù„Ù…ØªØ³Ù„Ù…Ø©</th>
              <th class="ecommerce-column">Ø§Ù„ØªÙƒÙ„ÙØ© Ø§Ù„ÙØ¹Ù„ÙŠØ© Ù„ÙƒÙ„ Ø§ÙˆØ±Ø¯Ø±</th>
              <th class="affiliate-column">ØªÙƒÙ„ÙØ© Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† Ù„ÙƒÙ„ Ø§ÙˆØ±Ø¯Ø±</th>
              <th class="ecommerce-column">Ø±Ø¨Ø­Ùƒ ÙÙŠ Ø§Ù„Ø§ÙˆØ±Ø¯Ø± Ø§Ù„ÙˆØ§Ø­Ø¯</th>
              <th class="affiliate-column">ØµØ§ÙÙŠ Ø±Ø¨Ø­ Ø§Ù„Ø£ÙˆØ±Ø¯Ø±</th>
              <th>Ù‡Ø§Ù…Ø´ %</th>
              <th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ ØªÙƒÙ„ÙØ© Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª</th>
              <th class="ecommerce-column">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø´Ø­Ù†</th>
              <th class="ecommerce-column">Ø¥Ø¬Ù…Ø§Ù„ÙŠ ØªÙƒÙ„ÙØ© Ø§Ù„Ø¨Ø¶Ø§Ø¹Ø©</th>
              <th class="ecommerce-column">Ø¥Ø¬Ù…Ø§Ù„ÙŠ ØªÙƒÙ„ÙØ© Ø´Ø­Ù† Ø§Ù„Ù…Ø±ØªØ¬Ø¹Ø§Øª</th>
              <th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª Ø§Ù„ØµØ§ÙÙŠØ©</th>
              <th>ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­ Ù„Ù„ØªØ§Ø±Ø¬Øª</th>
              <th>ROAS</th>
              <th>POAS</th>
              <th>ROI %</th>
              <th class="ecommerce-column">CAC</th>
              <th class="ecommerce-column">LTV</th>
              <th class="ecommerce-column">LTV / CAC</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
    <div class="table-card mt-3" id="ltv-table-detailed">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <div><strong>ğŸ“Š ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø±Ø¨Ø­ Ù…Ù‚Ø§Ø¨Ù„ Ø§Ù„Ø®Ø³Ø§Ø±Ø© Ù…Ø¹ LTV Ùˆ CAC</strong><div class="small-muted">Ù‡Ù†Ø§ Ù†Ø´ÙˆÙ Ø¥Ø²Ø§ÙŠ Ø§Ù„Ø®Ø³Ø§Ø±Ø© Ù…Ù…ÙƒÙ† ØªØªØ­ÙˆÙ„ Ù„Ø±Ø¨Ø­ Ø­Ø³Ø¨ LTV ÙˆCAC</div></div>
      </div>
      <div class="table-responsive">
        <table class="table table-bordered table-sm" id="ltvTable">
          <thead>
            <tr>
              <th>CPA</th>
              <th>CAC</th>
              <th>LTV</th>
              <th>LTV/CAC</th>
              <th>Ø§Ù„Ø­Ø§Ù„Ø© (Ø±Ø¨Ø­/Ø®Ø³Ø§Ø±Ø©)</th>
              <th>Ø§Ù„Ø±Ø¨Ø­ Ø§Ù„Ù…ØªÙˆÙ‚Ø¹ Ø¨Ø¹Ø¯ LTV</th>
            </tr>
</thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
    <div class="table-card mt-3" id="scenarios-table-detailed">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <div><strong>ğŸ¤” ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø³ÙŠÙ†Ø§Ø±ÙŠÙˆÙ‡Ø§Øª (ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­)</strong><div class="small-muted">ØªØ®Ù…ÙŠÙ†Ø§Øª Ù„Ù„Ø±Ø¨Ø­ Ù„Ùˆ ØªØºÙŠØ±Øª Ù†Ø³Ø¨Ø© Ø§Ù„ØªØ³Ù„ÙŠÙ… ÙˆØ§Ù„Ù€ CPA</div></div>
      </div>
      <div class="d-flex align-items-center gap-2 mb-2">
          <span>Ø§Ø¯Ø®Ù„ Ù‚ÙŠÙ…Ø© Ø§Ù„cpa Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ø³ÙŠÙ†Ø§Ø±ÙŠÙˆ:</span>
          <input type="number" id="scenarioCpaInput" class="form-control" style="width: auto; background-color: #e9ecef; border: 2px solid #007bff;" value="">
      </div>
      <div class="table-responsive">
        <table class="table table-bordered table-sm" id="scenariosTable">
          <thead>
            <tr>
              <th rowspan="2">Ø§Ù„Ø³ÙŠÙ†Ø§Ø±ÙŠÙˆ</th>
              <th colspan="10" id="cpaChangesHeader">Ø¥Ø°Ø§ ØªØºÙŠØ± Ø§Ù„Ù€ CPA Ø¨Ù€:</th>
            </tr>
            <tr>
              <th>-50</th>
              <th>-40</th>
              <th>-30</th>
              <th>-20</th>
              <th>-10</th>
              <th>+10</th>
              <th>+20</th>
              <th>+30</th>
              <th>+40</th>
              <th>+50</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
    <div class="table-card mt-3" id="charts-detailed">
      <div><strong>ğŸ“ˆ Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ©</strong></div>
      <div style="height:160px"><canvas id="profitChart" height="160"></canvas></div>
      <div style="height:160px"><canvas id="ltvChart" height="160" class="mt-4"></canvas></div>
    </div>
    <div class="muted mt-3">Ù…Ù„Ø§Ø­Ø¸Ø©: Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª ØªÙ‚Ø±ÙŠØ¨ÙŠØ© ÙˆØªØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª Ø§Ù„Ù„ÙŠ ÙƒØªØ¨ØªÙ‡Ø§ ÙÙˆÙ‚.</div>
  </div>
</div>

<div id="welcomePopup" class="popup-overlay">
  <div class="popup-content">
    <h2>Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ!</h2>
    <p>Ù†ÙˆØ±Øª Ø§Ù„Ù…ÙˆÙ‚Ø¹ØŒ Ù†ØªÙ…Ù†Ù‰ Ù„Ùƒ ØªØ¬Ø±Ø¨Ø© Ù…Ù…ØªØ¹Ø© ÙˆÙ…ÙÙŠØ¯Ø©.</p>
    <p class="palestine-support-message">Ù‡Ø°Ø§ Ø§Ù„Ù…ÙˆÙ‚Ø¹ ÙˆÙ…ØµÙ…Ù… Ù‡Ø°Ø§ Ø§Ù„Ù…ÙˆÙ‚Ø¹ ÙŠØ¯Ø¹Ù… Ø§Ù„Ù‚Ø¶ÙŠØ© Ø§Ù„ÙÙ„Ø³Ø·ÙŠÙ†ÙŠØ©</p>
    <span class="palestine-flag-emoji">ğŸ‡µğŸ‡¸</span>
    <h3>Ù„Ù„ØªÙˆØ§ØµÙ„ ÙˆØ§Ù„Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª</h3>
    <div class="social-icons">
      <a href="https://www.facebook.com/mahmoudzakiofficial" target="_blank" rel="noopener noreferrer"><i class="fab fa-facebook-square"></i></a>
      <a href="https://www.facebook.com/mahmoudzakiofficial" target="_blank" rel="noopener noreferrer"><i class="fab fa-whatsapp-square"></i></a>
    </div>
    <button class="close-btn" onclick="closePopup()">Ù…ØªØ§Ø¨Ø¹Ø©</button>
  </div>
</div>

<script>
(function(){
  const $ = id => document.getElementById(id);
  let currentMode = 'standard';
  let cpaList = [];
  const savedInputs = {
    standard: {
      price: "150", cogs: "50", shippingDelivered: "25", shippingReturn: "25",
      deliveryRate: "90", confirmationRate: "100", monthlyCosts: "", targetOrders: "100",
      ltvMultiplier: "1.2", cpaInput: "10,15,20,25,30"
    },
    advanced: {
      price: "150", cogs: "50", shippingDelivered: "25", shippingReturn: "25",
      deliveryRate: "90", confirmationRate: "80", monthlyCosts: "5000", targetOrders: "100",
      ltvMultiplier: "1.2", cpaInput: "10,15,20,25,30"
    },
    affiliate: {
      itemPrice: "100", shippingCost: "25", sellingPriceAffiliate: "150", deliveryRate: "90", confirmationRate: "80", targetOrders: "100", monthlyCosts: "",
      cpaInput: "10,15,20,25,30"
    }
  };
  const standardInputIds = ['price', 'cogs', 'shippingDelivered', 'shippingReturn', 'deliveryRate', 'targetOrders', 'ltvMultiplier', 'cpaInput'];
  const advancedInputIds = ['price', 'cogs', 'shippingDelivered', 'shippingReturn', 'deliveryRate', 'confirmationRate', 'monthlyCosts', 'targetOrders', 'ltvMultiplier', 'cpaInput'];
  const affiliateInputIds = ['itemPrice', 'shippingCost', 'sellingPriceAffiliate', 'orderCommission', 'deliveryRate', 'confirmationRate', 'targetOrders', 'monthlyCosts', 'cpaInput'];

  const allInputIds = [...new Set([...standardInputIds, ...advancedInputIds, ...affiliateInputIds])];

  function getRelevantInputIds(mode) {
    if (mode === 'standard') return standardInputIds;
    if (mode === 'advanced') return advancedInputIds;
    if (mode === 'affiliate') return affiliateInputIds;
    return [];
  }

  function setMode(mode) {
    saveInputs();
    currentMode = mode;
    const body = document.body;
    body.classList.remove('standard-mode', 'advanced-mode', 'affiliate-mode');
    body.classList.add(`${mode}-mode`);
    
    const btns = ['standardModeBtn', 'advancedModeBtn', 'affiliateModeBtn'];
    btns.forEach(btnId => {
      const btn = $(btnId);
      if(btn) {
        btn.classList.remove('btn-primary', 'btn-outline-secondary');
        btn.classList.add(btnId.startsWith(mode) ? 'btn-primary' : 'btn-outline-secondary');
      }
    });

    $('targetOrdersLabel').innerText = (mode === 'affiliate') ? 'Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙˆØ±Ø¯Ø±Ø§Øª' : ((mode === 'advanced') ? 'Ù…Ø¹Ø§Ùƒ ÙƒØ§Ù… Ø§ÙˆØ±Ø¯Ø±' : 'Ø¹Ø§ÙŠØ² ÙƒØ§Ù… Ø§ÙˆØ±Ø¯Ø±');
    
    loadInputs();
    calcAndRender();
  }

  function saveInputs() {
    const ids = getRelevantInputIds(currentMode);
    ids.forEach(id => {
      const input = $(id);
      if (input) {
        if (!savedInputs[currentMode]) {
          savedInputs[currentMode] = {};
        }
        savedInputs[currentMode][id] = input.value;
      }
    });
  }
  
  function loadInputs() {
    const source = savedInputs[currentMode] || {};
    const ids = getRelevantInputIds(currentMode);
    ids.forEach(id => {
      const input = $(id);
      if (input) {
        input.value = source.hasOwnProperty(id) ? source[id] : '';
      }
    });
    // For affiliate mode, re-calculate commission on load
    if (currentMode === 'affiliate') {
        updateOrderCommission();
    }
  }

  function updateOrderCommission() {
    const itemPrice = parseFloat($('itemPrice').value) || 0;
    const shippingCost = parseFloat($('shippingCost').value) || 0;
    const sellingPrice = parseFloat($('sellingPriceAffiliate').value) || 0;
    const commission = sellingPrice - (itemPrice + shippingCost);
    $('orderCommission').value = commission;
  }
  
  function setStatus(msg, isError=false){
    const el = $('status');
    if(el){ el.innerText = msg || ''; el.style.color = isError ? 'var(--bad)' : 'var(--good)'; }
    console.log('STATUS:', msg, isError);
  }
  
  function clearInputs(){
    savedInputs.standard = {};
    savedInputs.advanced = {};
    savedInputs.affiliate = {};
    allInputIds.forEach(id => {
      const input = $(id);
      if(input) input.value = '';
    });
    setStatus('ØªÙ… Ù…Ø³Ø­ ÙƒÙ„ Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª', false);
    $('summaryGrid-detailed').innerHTML = '';
    document.querySelector('#resultsTable tbody').innerHTML = '';
    document.querySelector('#ltvTable tbody').innerHTML = '';
    document.querySelector('#scenariosTable tbody').innerHTML = '';
    if(profitChart){ try{ profitChart.destroy(); }catch(e){} profitChart=null; }
    if(ltvChart){ try{ ltvChart.destroy(); }catch(e){} ltvChart=null; }
  }
  
  window.addEventListener('error', (e)=>{
    setStatus(e.message || 'Error occurred', true);
    console.error(e);
  });
  
  function parseCPAInput(text){
    const t = (text||'').trim();
    if(!t) return [10,20,30];
    if(t.indexOf('-')>-1 && t.indexOf(':')>-1){
      const parts = t.split(':');
      const rangePart = parts[0];
      const stepPart = parts[1] || '1';
      const [sStr, eStr] = rangePart.split('-');
      const s = parseFloat(sStr);
      const e = parseFloat(eStr);
      const step = parseFloat(stepPart);
      if(!isNaN(s) && !isNaN(e) && !isNaN(step) && step>0){
        const arr=[];
        for(let v=s; v<=e+1e-9; v+=step) arr.push(Math.round((v+Number.EPSILON)*100)/100);
        return arr;
      }
    }
    return t.split(',').map(v=>parseFloat(v.trim())).filter(v=>!isNaN(v));
  }
  
  function f(n){ return Math.round((Number(n)||0 + Number.EPSILON)*100)/100; }
  
  function compute(params, cpa){
    const {price, cogs, shippingDelivered, shippingReturn, deliveryRate, confirmationRate, monthlyCosts, targetOrders, ltvMultiplier, itemPrice, shippingCost, sellingPriceAffiliate} = params;
    
    let deliveredOrders, confirmedOrders, totalAds, totalRevenueNet, totalCosts, netProfit, profitPerDelivered, effectiveAdPerDelivered;
    const orders = Number(targetOrders) || 0;
    const monthlyCostsNum = Number(monthlyCosts) || 0;
    
    if (currentMode === 'affiliate') {
        confirmedOrders = orders * (confirmationRate / 100);
        deliveredOrders = confirmedOrders * (deliveryRate / 100);
        totalAds = cpa * confirmedOrders;
        totalRevenueNet = deliveredOrders * sellingPriceAffiliate;
        const totalItemAndShippingCost = (deliveredOrders * itemPrice) + (deliveredOrders * shippingCost);
        totalCosts = totalAds + totalItemAndShippingCost + monthlyCostsNum;
        
        const totalNonAdCosts = totalItemAndShippingCost + monthlyCostsNum;
        let breakEvenCPA = 0;
        if (confirmedOrders > 0) {
            breakEvenCPA = f( (totalRevenueNet - totalNonAdCosts) / confirmedOrders );
        }
        
        let breakEvenRoas = "ØºÙŠØ± Ù…Ø­Ø¯Ø¯";
        const totalProfitBeforeAds = totalRevenueNet - totalNonAdCosts;
        if (totalProfitBeforeAds > 0) {
             breakEvenRoas = f(totalRevenueNet / totalProfitBeforeAds);
        }

        netProfit = totalRevenueNet - totalCosts;
        profitPerDelivered = deliveredOrders > 0 ? (netProfit / deliveredOrders) : -cpa;
        effectiveAdPerDelivered = deliveredOrders > 0 ? totalAds / deliveredOrders : cpa;
        const marginPct = totalRevenueNet > 0 ? (netProfit / totalRevenueNet * 100) : 0;
        const roi = totalCosts > 0 ? (netProfit / totalCosts * 100) : 0;
        const roas = totalAds > 0 ? (totalRevenueNet / totalAds) : 0;
        const poas = totalAds > 0 ? (netProfit / totalAds) : 0;
        
        return {
            cpa: f(cpa), deliveredOrders: f(deliveredOrders), confirmedOrders: f(confirmedOrders), totalAds: f(totalAds),
            totalRevenueNet: f(totalRevenueNet), netProfit: f(netProfit),
            profitPerDelivered: f(profitPerDelivered), effectiveAdPerDelivered: f(effectiveAdPerDelivered),
            marginPct: f(marginPct), roi: f(roi), roas: f(roas),
            poas: f(poas),
            breakEvenCPA: breakEvenCPA, breakEvenRoas: breakEvenRoas
        };
    } else { // Standard and Advanced modes
        confirmedOrders = (currentMode === 'advanced') ? (orders * (confirmationRate / 100)) : orders;
        deliveredOrders = confirmedOrders * (deliveryRate / 100);
        
        totalAds = cpa * orders;
        
        const returnedOrders = Math.max(0, confirmedOrders - deliveredOrders);
        effectiveAdPerDelivered = deliveredOrders > 0 ? totalAds / deliveredOrders : 0;
        const totalShipping = deliveredOrders * shippingDelivered;
        const totalCOGS = deliveredOrders * cogs;
        const totalReturnCost = returnedOrders * shippingReturn;
        totalRevenueNet = deliveredOrders * price;
        
        totalCosts = totalAds + totalShipping + totalCOGS + totalReturnCost + (currentMode === 'advanced' ? monthlyCostsNum : 0);
        netProfit = totalRevenueNet - totalCosts;
        profitPerDelivered = deliveredOrders > 0 ? (netProfit / deliveredOrders) : 0;
        
        const totalNonAdCosts = totalShipping + totalCOGS + totalReturnCost + (currentMode === 'advanced' ? monthlyCostsNum : 0);
        
        let breakEvenCPA = 0;
        if (orders > 0) {
            breakEvenCPA = f( (totalRevenueNet - totalNonAdCosts) / orders );
        }
        
        let breakEvenRoas = "ØºÙŠØ± Ù…Ø­Ø¯Ø¯";
        if (breakEvenCPA > 0 && totalRevenueNet > 0) {
            const totalAdsBreakEven = breakEvenCPA * orders;
            if (totalAdsBreakEven > 0) {
                 breakEvenRoas = f(totalRevenueNet / totalAdsBreakEven);
            }
        }

        const marginPct = totalRevenueNet > 0 ? (netProfit / totalRevenueNet * 100) : 0;
        const roi = totalCosts > 0 ? (netProfit / totalCosts * 100) : 0;
        const cac = deliveredOrders > 0 ? totalAds / deliveredOrders : 0;
        const ltv = (price - cogs - shippingDelivered) * ltvMultiplier;
        const ltvToCac = cac > 0 ? ltv / cac : 0;
        const roas = totalAds > 0 ? (totalRevenueNet / totalAds) : 0;
        const poas = totalAds > 0 ? (netProfit / totalAds) : 0;

        return {
            cpa: f(cpa), deliveredOrders: f(deliveredOrders), confirmedOrders: f(confirmedOrders), effectiveAdPerDelivered: f(effectiveAdPerDelivered),
            profitPerDelivered: f(profitPerDelivered), totalAds: f(totalAds), totalShipping: f(totalShipping), totalCOGS: f(totalCOGS), totalReturnCost: f(totalReturnCost),
            totalRevenueNet: f(totalRevenueNet), netProfit: f(netProfit), marginPct: f(marginPct), roi: f(roi), cac: f(cac), ltv: f(ltv), ltvToCac: f(ltvToCac),
            roas: f(roas), poas: f(poas),
            breakEvenCPA: f(breakEvenCPA), breakEvenRoas: breakEvenRoas
        };
    }
  }
  
  let profitChart = null, ltvChart = null;
  function renderCharts(rows){
    if (currentMode === 'affiliate') {
        $('ltv-table-detailed').style.display = 'none';
        $('charts-detailed').style.display = 'none';
    } else {
        $('ltv-table-detailed').style.display = 'block';
        $('charts-detailed').style.display = 'block';
    }
    
    try{
      if(typeof Chart === 'undefined'){ setStatus('Chart.js ØºÙŠØ± Ù…Ø­Ù…Ù‘Ù„ â€” Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ© Ù„Ù† ØªØ¸Ù‡Ø±', true); return; }
      const labels = rows.map(r=>r.cpa);
      const profitData = rows.map(r=>r.netProfit);
      if(profitChart){ try{ profitChart.destroy(); }catch(e){} profitChart=null; }
      if(ltvChart){ try{ ltvChart.destroy(); }catch(e){} ltvChart=null; }
      
      const profitCtx = document.getElementById('profitChart').getContext('2d');
      profitChart = new Chart(profitCtx, {
        type: 'line',
        data: { labels, datasets: [{ label: 'ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­', data: profitData, fill:false, tension:0.3, pointRadius:4 }] },
        options: { responsive:true, maintainAspectRatio:false, scales:{ x:{ title:{display:true,text:'CPA'} }, y:{ title:{display:true,text:'ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­'} } } }
      });
      
      if(currentMode !== 'affiliate') {
        const ltvRatioData = rows.map(r=>f(r.ltvToCac));
        const ltvCtx = document.getElementById('ltvChart').getContext('2d');
        ltvChart = new Chart(ltvCtx, { type:'bar', data:{ labels, datasets:[{ label:'LTV / CAC', data:ltvRatioData, borderWidth:1 }] }, options:{ responsive:true, maintainAspectRatio:false, scales:{ x:{ title:{display:true,text:'CPA'} }, y:{ title:{display:true,text:'LTV / CAC'}, beginAtZero:true } } } });
      }
      
      setStatus('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ ÙˆØ§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ©', false);
    }catch(err){ console.error(err); setStatus('Ø®Ø·Ø£ ÙÙŠ Ø¹Ø±Ø¶ Ø§Ù„Ø±Ø³ÙˆÙ…: '+err.message, true); }
  }

  function renderScenarioTable(initialParams, initialCpa){
    const scenariosTableBody = document.querySelector('#scenariosTable tbody');
    scenariosTableBody.innerHTML = '';
    const currency = $('currency').value || 'EGP';
    const deliveryRateChanges = [-20, -15, -10, -5, 5, 10, 15, 20];
    const cpaChanges = [-50, -40, -30, -20, -10, 10, 20, 30, 40, 50];
    const initialDeliveryRate = parseFloat(initialParams.deliveryRate);
    const initialCpaNum = parseFloat(initialCpa);
    
    // Validate the input CPA for the scenario
    if (isNaN(initialCpaNum) || initialCpaNum <= 0) {
      scenariosTableBody.innerHTML = `<tr><td colspan="11" style="text-align: center;">Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ù‚ÙŠÙ…Ø© CPA ØµØ§Ù„Ø­Ø© ÙˆÙ…ÙˆØ¬Ø¨Ø© Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ø³ÙŠÙ†Ø§Ø±ÙŠÙˆ.</td></tr>`;
      return;
    }

    deliveryRateChanges.forEach(change => {
      let newDeliveryRate = initialDeliveryRate + change;
      newDeliveryRate = Math.min(100, newDeliveryRate);
      const tr = document.createElement('tr');
      const changeText = change > 0 ? `${change}%+` : `${Math.abs(change)}%-`;
      let cells = `<td>${newDeliveryRate}% (${changeText})</td>`;

      cpaChanges.forEach(cpaChange => {
        const newCpa = initialCpaNum + cpaChange;
        
        // Check if the new CPA is a valid positive number
        if (newCpa <= 0) {
          cells += `<td class="value">---</td>`;
        } else {
          const scenarioParams = { ...initialParams, deliveryRate: newDeliveryRate };
          const result = compute(scenarioParams, newCpa);
          const profit = result.netProfit;
          const profitClass = profit >= 0 ? 'good' : 'bad';
          cells += `<td class="value ${profitClass}">${f(profit)} ${currency}</td>`;
        }
      });
      tr.innerHTML = cells;
      scenariosTableBody.appendChild(tr);
    });
  }

  function calcAndRender(){
    try{
      setStatus('...Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­Ø³Ø§Ø¨');
      const currency = $('currency').value || 'EGP';
      
      saveInputs();
      
      const params = savedInputs[currentMode];
      
      cpaList = parseCPAInput(params.cpaInput);
      if(!cpaList.length){ setStatus('Ù…Ø­ØªØ§Ø¬ ØªØ­Ø· Ù‚ÙŠÙ… CPA ØµØ­ÙŠØ­Ø©', true); return; }
      
      const rows = cpaList.map(cpa => compute(params, cpa));
      
      const summaryGrid = $('summaryGrid-detailed');
      const resultsTableBody = document.querySelector('#resultsTable tbody');
      
      summaryGrid.innerHTML = '';
      resultsTableBody.innerHTML = '';
      
      const r = rows[0];

      const avgProfitPerDelivered = rows.reduce((sum, row) => sum + row.profitPerDelivered, 0) / rows.length;
      const avgNetProfit = rows.reduce((sum, row) => sum + row.netProfit, 0) / rows.length;
      const avgROI = rows.reduce((sum, row) => sum + row.roi, 0) / rows.length;
      const avgCPA = rows.reduce((sum, row) => sum + row.cpa, 0) / rows.length;
      const avgRoas = rows.reduce((sum, row) => sum + row.roas, 0) / rows.length;
      const avgPoas = rows.reduce((sum, row) => sum + row.poas, 0) / rows.length;

      summaryGrid.innerHTML = `
        <div class="summary-card blue">
          <div class="title">Ø§Ù„Ø±Ø¨Ø­ Ø§Ù„ØµØ§ÙÙŠ Ù„ÙƒÙ„ Ø£ÙˆØ±Ø¯Ø± (Ù…ØªÙˆØ³Ø·)</div>
          <div class="value ${avgProfitPerDelivered>=0 ? 'good' : 'bad'}">${f(avgProfitPerDelivered)} ${currency}</div>
          <div class="small-muted">Ù…ØªÙˆØ³Ø· Ø¹Ù„Ù‰ ÙƒÙ„ Ø§Ù„Ù€ CPAs</div>
        </div>
        <div class="summary-card green">
          <div class="title">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø±Ø¨Ø­ Ø§Ù„ØµØ§ÙÙŠ (Ù…ØªÙˆØ³Ø·)</div>
          <div class="value">${f(avgNetProfit)} ${currency}</div>
          <div class="small-muted">Ù…ØªÙˆØ³Ø· Ø¹Ù„Ù‰ ÙƒÙ„ Ø§Ù„Ù€ CPAs</div>
        </div>
        <div class="summary-card green">
          <div class="title">ğŸ† Ù…ØªÙˆØ³Ø· CPA</div>
          <div class="value">${f(avgCPA)} ${currency}</div>
          <div class="small-muted">Ù…ØªÙˆØ³Ø· Ø¹Ù„Ù‰ ÙƒÙ„ Ø§Ù„Ù€ CPAs</div>
        </div>
        <div class="summary-card purple">
          <div class="title">ğŸ“ˆ Ø§Ù„Ù€ ROI Ø§Ù„ØµØ§ÙÙŠ (Ù…ØªÙˆØ³Ø·)</div>
          <div class="value">${f(avgROI)} %</div>
          <div class="small-muted">Ù…ØªÙˆØ³Ø· Ø¹Ù„Ù‰ ÙƒÙ„ Ø§Ù„Ù€ CPAs</div>
        </div>
        <div class="summary-card orange">
          <div class="title">âš–ï¸ Break-Even CPA</div>
          <div class="value">${f(r.breakEvenCPA)} ${currency}</div>
          <div class="small-muted">Ø£Ù‚ØµÙ‰ CPA Ù„Ù„Ø±Ø¨Ø­ 0</div>
        </div>
        <div class="summary-card purple">
          <div class="title">ğŸ“Š ROAS Ù†Ù‚Ø·Ø© Ø§Ù„ØªØ¹Ø§Ø¯Ù„</div>
          <div class="value">${f(r.breakEvenRoas)}x</div>
          <div class="small-muted">Ø§Ù„Ø£Ø±Ø¨Ø§Ø­ = ØµÙØ±</div>
        </div>
      `;
      
      rows.forEach(r=>{
        const tr = document.createElement('tr');
        let profitClass = 'good';
        if(r.netProfit<0) profitClass='bad';
        else if(Math.abs(r.netProfit)<Math.abs(r.totalRevenueNet)*0.05) profitClass='warn';
        
        tr.innerHTML = `
          <td>${r.cpa}</td>
          <td>${r.deliveredOrders}</td>
          <td class="ecommerce-column">${r.effectiveAdPerDelivered} ${currency}</td>
          <td class="affiliate-column">${r.effectiveAdPerDelivered} ${currency}</td>
          <td class="ecommerce-column value ${r.profitPerDelivered>=0?'good':'bad'}">${r.profitPerDelivered} ${currency}</td>
          <td class="affiliate-column value ${r.profitPerDelivered>=0?'good':'bad'}">${r.profitPerDelivered} ${currency}</td>
          <td>${r.marginPct}%</td>
          <td>${r.totalAds} ${currency}</td>
          <td class="ecommerce-column">${r.totalShipping} ${currency}</td>
          <td class="ecommerce-column">${r.totalCOGS} ${currency}</td>
          <td class="ecommerce-column">${r.totalReturnCost} ${currency}</td>
          <td>${r.totalRevenueNet} ${currency}</td>
          <td class="value ${profitClass}">${r.netProfit} ${currency}</td>
          <td>${r.roas}x</td>
          <td>${r.poas}x</td>
          <td>${r.roi} %</td>
          <td class="ecommerce-column">${r.cac} ${currency}</td>
          <td class="ecommerce-column">${r.ltv} ${currency}</td>
          <td class="ecommerce-column">${f(r.ltvToCac)}</td>
        `;
        resultsTableBody.appendChild(tr);
      });

      if(currentMode !== 'affiliate') {
        const ltvTableBody = document.querySelector('#ltvTable tbody');
        ltvTableBody.innerHTML = '';
        rows.forEach(r=>{
          const tr = document.createElement('tr');
          const state = r.ltvToCac >= 1 ? 'Ø±Ø¨Ø­' : 'Ø®Ø³Ø§Ø±Ø©';
          const expectedProfit = (r.ltvToCac-1)*r.cac*r.deliveredOrders;
          tr.innerHTML = `
            <td>${r.cpa}</td>
            <td>${r.cac} ${currency}</td>
            <td>${r.ltv} ${currency}</td>
            <td>${f(r.ltvToCac)}</td>
            <td class="value ${state==='Ø±Ø¨Ø­'?'good':'bad'}">${state}</td>
            <td>${f(expectedProfit)} ${currency}</td>
          `;
          ltvTableBody.appendChild(tr);
        });
      }
      
      try{ renderCharts(rows); }catch(e){ console.error(e); }
      
      const scenarioCpaInput = $('scenarioCpaInput');
      if (scenarioCpaInput.value === '' && cpaList.length > 0) {
        scenarioCpaInput.value = cpaList[0];
      }
      const selectedCpa = scenarioCpaInput.value;
      renderScenarioTable(params, selectedCpa);

      setStatus('ØªÙ… Ø§Ù„Ø­Ø³Ø§Ø¨ â€” Ø´ÙˆÙ Ø§Ù„Ø¬Ø¯ÙˆÙ„ ÙˆØ§Ù„Ø±Ø³ÙˆÙ… ØªØ­Øª', false);
    }catch(err){ console.error(err); setStatus('Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨: '+err.message, true); }
  }
  
  function exportCsvFn(){
    try{
      const rows = Array.from(document.querySelectorAll('#resultsTable tbody tr'));
      const header = Array.from(document.querySelectorAll('#resultsTable thead th')).map(th=>th.innerText);
      if(!rows.length){ setStatus('Ù…ÙÙŠØ´ Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ø´Ø§Ù† ØªØ­Ù…ÙŠÙ„ CSV', true); return; }
      const data = [header].concat(rows.map(row => Array.from(row.querySelectorAll('td')).map(cell=>cell.innerText)));
      const csvContent = data.map(r=>r.map(c=>`"${String(c).replace(/"/g,'""')}"`).join(',')).join('\n');
      const blob = new Blob([csvContent], {type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url; link.download = 'results.csv';
      document.body.appendChild(link);
      link.click();
      link.remove();
      URL.revokeObjectURL(url);
      setStatus('CSV ØªÙ… ØªÙ†Ø²ÙŠÙ„Ù‡', false);
    }catch(err){ console.error(err); setStatus('ÙØ´Ù„ ØªØµØ¯ÙŠØ± CSV: '+err.message, true); }
  }
  
  function exportPdfFn(){
    try{
      if(typeof html2canvas === 'undefined' || (typeof window.jspdf === 'undefined' && typeof jspdf === 'undefined')){
        setStatus('html2canvas Ø£Ùˆ jspdf ØºÙŠØ± Ù…Ø­Ù…Ù‘Ù„ÙŠÙ† â€” Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØµØ¯ÙŠØ± PDF', true); return;
      }
      const JsPDF = (window.jspdf && window.jspdf.jsPDF) ? window.jspdf.jsPDF : (typeof jspdf !== 'undefined' && jspdf.jsPDF ? jspdf.jsPDF : null);
      if(!JsPDF){ setStatus('jspdf ØºÙŠØ± Ù…ØªÙˆÙØ± Ù„Ø¹Ù…Ù„ PDF', true); return; }
      setStatus('Ø¬Ø§Ø±ÙŠ ØªØ¬Ù‡ÙŠØ² PDF â€” Ø§Ù†ØªØ¸Ø± Ù„Ø­Ø¸Ø©...');
      html2canvas(document.querySelector('.card-app'), {useCORS:true, scale:1.5}).then(canvas=>{
        const imgData = canvas.toDataURL('image/png');
        const pdf = new JsPDF('p','pt','a4');
        const imgProps = pdf.getImageProperties(imgData);
        const pdfWidth = pdf.internal.pageSize.getWidth();
        const pdfHeight = (imgProps.height * pdfWidth)/imgProps.width;
        pdf.addImage(imgData,'PNG',0,0,pdfWidth,pdfHeight);
        pdf.save('results.pdf');
        setStatus('ØªÙ… ØªÙ†Ø²ÙŠÙ„ PDF', false);
      }).catch(err=>{ console.error(err); setStatus('ÙØ´Ù„ Ø¥Ù†Ø´Ø§Ø¡ ØµÙˆØ±Ø© PDF: '+err.message, true); });
    }catch(err){ console.error(err); setStatus('ÙØ´Ù„ ØªØµØ¯ÙŠØ± PDF: '+err.message, true); }
  }

  // Popup Functions
  function showPopup() {
    const popup = $('welcomePopup');
    if (popup) {
      popup.style.visibility = 'visible';
      popup.style.opacity = '1';
    }
  }

  window.closePopup = function() {
    const popup = $('welcomePopup');
    if (popup) {
      popup.style.visibility = 'hidden';
      popup.style.opacity = '0';
    }
  }
  
  function init(){
    const calcBtn = $('calcBtn');
    const clearBtn = $('clearBtn');
    const exportCsv = $('exportCsv');
    const exportPdf = $('exportPdf');
    const standardModeBtn = $('standardModeBtn');
    const advancedModeBtn = $('advancedModeBtn');
    const affiliateModeBtn = $('affiliateModeBtn');

    if(!calcBtn || !clearBtn || !exportCsv || !exportPdf || !standardModeBtn || !advancedModeBtn || !affiliateModeBtn){
      setTimeout(init,100);
      return;
    }
    
    // Add event listeners to all relevant input fields to save changes
    allInputIds.forEach(id => {
      const input = $(id);
      if (input) {
        input.addEventListener('change', saveInputs);
      }
    });

    calcBtn.addEventListener('click', calcAndRender);
    clearBtn.addEventListener('click', clearInputs);
    exportCsv.addEventListener('click', exportCsvFn);
    exportPdf.addEventListener('click', exportPdfFn);
    standardModeBtn.addEventListener('click', () => setMode('standard'));
    advancedModeBtn.addEventListener('click', () => setMode('advanced'));
    affiliateModeBtn.addEventListener('click', () => setMode('affiliate'));
    
    // Add event listener for the new scenario CPA input field
    const scenarioCpaInput = $('scenarioCpaInput');
    scenarioCpaInput.addEventListener('input', (event) => {
        const selectedCpa = event.target.value;
        const params = savedInputs[currentMode];
        renderScenarioTable(params, selectedCpa);
    });

    // Add event listeners to calculate commission in real time for affiliate mode
    ['itemPrice', 'shippingCost', 'sellingPriceAffiliate'].forEach(id => {
      const input = $(id);
      if (input) {
        input.addEventListener('input', () => {
          if (currentMode === 'affiliate') {
            updateOrderCommission();
          }
        });
      }
    });

    // Set initial mode to standard and load default values
    setMode('standard');

    // Show popup after 1 second
    setTimeout(showPopup, 1000);

    if(window._chartLoadError) setStatus('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Chart.js â€” Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ© Ù„Ù† ØªØ¹Ù…Ù„', true);
    if(window._html2canvasLoadError) setStatus('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ html2canvas â€” ØªØµØ¯ÙŠØ± PDF Ù„Ù† ÙŠØ¹Ù…Ù„', true);
    if(window._jspdfLoadError) setStatus('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ jspdf â€” ØªØµØ¯ÙŠØ± PDF Ù„Ù† ÙŠØ¹Ù…Ù„', true);
  }
  
  window.addEventListener('load', init);
})();
</script>
</body>
</html>
